# HOMER with Heplify for Cisco CUBE ERSPAN SIP Capture

This repository provides a configuration and deployment script for setting up **HOMER 7.7** with additional services, including Grafana, Prometheus, Loki, NGINX as a reverse proxy, and Heplify as a HEP capture agent, all orchestrated via Docker Compose. This assembly was specifically designed to collect SIP traffic from Cisco CUBE voice gateways using ERSPAN, enabling detailed analysis and monitoring of VoIP communications. The deployment is fully automated through a single script, enabling easy setup on a production server with minimal manual intervention.

## Prerequisites

- A Linux server (Ubuntu recommended) with internet access.
- Root or sudo privileges on the server.

## Deployment Instructions

Follow these steps to deploy HOMER and its associated services on a production server:

1. **Clone the repository:**
   ```bash
   git clone https://github.com/valandvir/homer-deployment.git
   
2. **Navigate to the directory:**
   ```bash
   cd homer-deployment

4. **Make the deployment script executable:**
   ```bash
   sudo chmod +x deploy.sh
   
5. **Run the deployment script:**
   ```bash
   sudo ./deploy.sh

* When prompted, enter the name of the CAPTURE interface (e.g., ens192) or press Enter to use the default value (ens192).

* The script will:

   * Install Docker and the Docker Compose plugin if not already present.
   * Create the required directory structure (/opt/homer/).
   * Generate self-signed SSL certificates for NGINX.
   * Download the homer7-docker repository.
   * Copy modified configuration files from this repository.
   * Set up environment variables in .env.
   * Start all services using Docker Compose.
* Note: If the script adds your user to the docker group, youâ€™ll need to log out and log back in for the changes to take effect, allowing you to run docker commands without sudo.


## Verification
After the deployment script completes, verify the setup:

1. **Check the generated .env file:**
   ```bash
   cat /opt/homer/homer7-docker/heplify-server/hom7-prom-all/.env

**Expected output:**
```
CAPTURE_INTERFACE=ens192
SERVER_HOSTNAME=<your_FQDN>
HOMER_DST=127.0.0.1
```
* <your_FQDN> will be the fully qualified domain name of your server (e.g., prod.example.com), automatically determined by hostname -f.


2. **Verify that services are running:**
   ```bash
   cd /opt/homer/homer7-docker/heplify-server/hom7-prom-all/
   ```
   ```bash
   docker compose ps
   ```

* Run this command from /opt/homer/homer7-docker/heplify-server/hom7-prom-all/ (since homer-deployment is deleted).
* Expected output: A list of services (e.g., heplify, nginx, homer-webapp, etc.) with a status of Up.

## Repository Contents
   * docker-compose.yml: Modified Docker Compose configuration with added heplify and nginx services.
   * default.conf.template: NGINX configuration template for reverse proxying HOMER and Grafana over HTTPS.
   * deploy.sh: Deployment script that automates the entire setup process.

## Service Details
* Heplify: Configured to run with the ERSPAN parameter, this service captures SIP traffic from Cisco CUBE using Encapsulated Remote SPAN (ERSPAN). It is designed to collect and forward SIP packets to HOMER for analysis and storage.

### Cisco CUBE ERSPAN Configuration Example
To configure ERSPAN on a Cisco CUBE to send SIP traffic to the Heplify agent, use the following example configuration:
```
! Define the ERSPAN source session on Cisco CUBE
monitor session 1 type erspan-source
 description Capture SIP traffic for HOMER
 source interface GigabitEthernet0/0/1  ! Replace with your SIP traffic interface
 destination
  erspan-id 10                          ! Unique ERSPAN session ID
  ip address <heplify_server_ip>        ! IP address of the server running Heplify
  origin ip address <cube_ip>           ! IP address of the Cisco CUBE
  no shutdown
```
* Replace <heplify_server_ip> with the IP address of your server running Heplify (e.g., the IP bound to ens192).
* Replace <cube_ip> with the IP address of your Cisco CUBE.
This configuration mirrors SIP traffic from the specified interface to the Heplify agent over ERSPAN.

## Notes
* Ensure your server's hostname is correctly configured (check with hostname -f) as it is used for the SERVER_HOSTNAME variable and SSL certificate generation.
* The CAPTURE interface (ens192 by default) must match the network interface on your production server receiving ERSPAN traffic from Cisco CUBE.
* Self-signed certificates are generated by default. For production use, consider replacing them with valid certificates (e.g., from Let's Encrypt).
* The homer-deployment directory is automatically removed after deployment; subsequent operations should be performed from /opt/homer/homer7-docker/heplify-server/hom7-prom-all/.

## Troubleshooting
* If you encounter errors like $'\r': command not found, ensure the script uses LF line endings (run dos2unix deploy.sh or recreate it on Linux).
* If services fail to start, check logs with sudo docker logs <container_name> (e.g., sudo docker logs heplify).
```
- **Docker permission denied after deployment**: If you see `permission denied` when running `docker compose ps` without `sudo`, it may mean your user was added to the `docker` group during deployment. Log out and log back in to apply the group changes, then retry the command.
```

## Contributing
Feel free to submit issues or pull requests to enhance this deployment setup.

### Acknowledgments
Based on the official homer7-docker repository: https://github.com/sipcapture/homer7-docker.
Thanks to the HOMER community for providing a robust SIP capture solution.
